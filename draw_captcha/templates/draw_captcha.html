{% load i18n %}

<input id="captcha_input_{{ name }}" type="hidden" name="{{ name }}">

<div id="captcha_element_{{ name }}" style="width: 400px; height: 480px;">
    <div style="text-align: center; font-family: Arial; color: #aaa; font-size: 32px; font-weight: bold; vertical-align: middle; line-height: 480px;">
        {% trans 'Loading...' %}
    </div>
</div>

<script>
{
    var input_id = 'captcha_input_{{ name }}';
    var elem_id = 'captcha_element_{{ name }}';

    showText = function(text)
    {
        var div = $('<div style="text-align: center; font-family: Arial; color: #aaa; font-size: 32px; font-weight: bold; vertical-align: middle; line-height: 480px;"></div>')
        div.text(text);
        $('#' + elem_id).html(div);
    }

    drawCircle = function(ctx, x, y, radius)
    {
        ctx.beginPath();
        ctx.arc(x, y, radius - 0.5, 0, 2 * Math.PI);
        ctx.fill();
    }

    drawLine = function(ctx, x1, y1, x2, y2, radius)
    {
        ctx.beginPath();
        ctx.lineWidth = radius * 2;
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    }

    showDrawingTool = function(instructions)
    {
        // Header
        var header = $('<div style="display: inline-block; vertical-align: bottom; width: 400px; height: 50px; text-align: center; font-family: Arial; color: #aaa; font-size: 24px; font-weight: bold; vertical-align: middle; line-height: 50px;">' + instructions + '</div>');

        // Canvas
        var canvas = $('<canvas width="400" height="400" style="display: inline-block; vertical-align: bottom;">');
        var ctx = canvas[0].getContext('2d');

        // Fill with white background
        ctx.beginPath();
        ctx.rect(0, 0, 400, 400);
        ctx.fillStyle = "#fff";
        ctx.fill();

        ctx.fillStyle = "#000";

        // Drawing state
        var paint = false;
        var last_mouse_x = 0;
        var last_mouse_y = 0;
        var line_width = 5;

        // Drawing events
        canvas.mousedown(function(e) {
            var mouse_x = e.pageX - ctx.canvas.offsetLeft;
            var mouse_y = e.pageY - ctx.canvas.offsetTop;

            paint = true;

            drawCircle(ctx, mouse_x, mouse_y, line_width / 2);

            last_mouse_x = mouse_x;
            last_mouse_y = mouse_y;
        });
        $(document).mousemove(function(e) {
            if (paint) {
                var mouse_x = e.pageX - ctx.canvas.offsetLeft;
                var mouse_y = e.pageY - ctx.canvas.offsetTop;

                drawLine(ctx, last_mouse_x, last_mouse_y, mouse_x, mouse_y, line_width / 2);
                drawCircle(ctx, mouse_x, mouse_y, line_width / 2);

                last_mouse_x = mouse_x;
                last_mouse_y = mouse_y;
            }
        });
        $(document).mouseup(function(e) {
            paint = false;
        });

        // "Ready" button
        var ready_button = $('<button>{% trans "Ready!" %}</button>');
        ready_button.on('click', function(e) {
            e.preventDefault();

            showText('{% trans "Loading..." %}');

            // Convert canvas to POST data
            var data = {
                drawing: canvas[0].toDataURL()
            }

            // Actual submit
            $.ajax({
                url: '/draw_captcha/upload_drawing',
                type: 'post',
                data: data,
                error: function() {
                    showText('{% trans "Error when uploading!" %}');
                },
                success: function(data) {
                    startNewTask();
                },
            });
        });

        // Footer
        var footer = $('<div style="display: inline-block; vertical-align: bottom; width: 400px; height: 30px; text-align: center;"></div>');
        footer.html(ready_button);

        // Combine all elements
        $('#' + elem_id).html(header);
        $('#' + elem_id).append(canvas);
        $('#' + elem_id).append(footer);
    }

    showSelectonTool = function(instructions, pictures)
    {
        // First add instructions
        $('#' + elem_id).html('<div style="display: inline-block; vertical-align: bottom; width: 400px; height: 50px; text-align: center; font-family: Arial; color: #aaa; font-size: 24px; font-weight: bold; vertical-align: middle; line-height: 50px;">' + instructions + '</div>');

        var selected_pictures = [];

        // Add pictures
        for (var i = 0; i < pictures.length; ++ i) {
            var picture = pictures[i];
            var img = $('<img style="display: inline-block; vertical-align: bottom; width: 100px; height: 100px;" src="' + picture[1] + '" width="100" height="100">');
            img.data('picture_id', picture[0]);
            img.on('click', function(e) {
                var img = $(e.target);
                if (img.css('opacity') > 0.65) {
                    img.css('opacity', 0.3);
                    selected_pictures.push(img.data('picture_id'));
                } else {
                    img.css('opacity', 1.0);
                    selected_pictures.splice(selected_pictures.indexOf(img.data('picture_id')), 1);
                }
            });
            $('#' + elem_id).append(img);
        }

        // Add "Ready" button
        var button = $('<div style="display: inline-block; vertical-align: bottom; width: 400px; height: 30px; text-align: center;"><button>{% trans "Ready!" %}</button>');
        button.on('click', function(e) {
            e.preventDefault();

            showText('{% trans "Loading..." %}');

            $.ajax({
                url: '/draw_captcha/complete_task',
                type: 'post',
                data: {pictures_ids: selected_pictures.join()},
                error: function() {
                    showText('{% trans "Error when completing captcha!" %}');
                },
                success: function(data) {
                    if (data.secret) {
                        $('#' + input_id).val(data.secret);
                        showText('{% trans "Completed!" %}');
                    } else {
                        startNewTask();
                    }
                },
            });
        });
        $('#' + elem_id).append(button);
    }

    startNewTask = function()
    {
        // Fetch captcha details
        $.ajax({
            url: '/draw_captcha/get_task',
            error: function() {
                showText('{% trans "Error in captcha!" %}');
            },
            success: function(data) {
                if (data.secret) {
                    $('#' + input_id).val(data.secret);
                    showText('{% trans "Completed!" %}');
                } else if (data.draw) {
                    showDrawingTool(data.instructions);
                } else {
                    showSelectonTool(data.instructions, data.pictures);
                }
            },
        });
    }

    startNewTask();
};
</script>
